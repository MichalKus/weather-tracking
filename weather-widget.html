<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Widget for Notion</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .weather-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            max-width: 500px;
            width: 100%;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .weather-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        
        .loading {
            font-size: 18px;
            color: #666;
            padding: 40px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            color: #e74c3c;
            font-size: 16px;
            padding: 30px 20px;
            line-height: 1.5;
        }
        
        .error small {
            display: block;
            margin-top: 15px;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .location {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .current-weather {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .weather-icon {
            font-size: 60px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }
        
        .temperature {
            font-size: 48px;
            font-weight: 300;
            color: #2c3e50;
        }
        
        .description {
            font-size: 18px;
            color: #7f8c8d;
            margin-bottom: 25px;
            text-transform: capitalize;
        }
        
        .details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .detail-item {
            background: rgba(103, 126, 234, 0.1);
            padding: 15px;
            border-radius: 12px;
            transition: all 0.2s ease;
        }
        
        .detail-item:hover {
            background: rgba(103, 126, 234, 0.15);
            transform: translateY(-2px);
        }
        
        .detail-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .forecast {
            margin-top: 30px;
        }
        
        .forecast-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .forecast-days {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }
        
        .forecast-day {
            flex: 1;
            min-width: 80px;
            background: rgba(103, 126, 234, 0.05);
            padding: 15px 10px;
            border-radius: 12px;
            transition: all 0.2s ease;
        }
        
        .forecast-day:hover {
            background: rgba(103, 126, 234, 0.1);
            transform: translateY(-3px);
        }
        
        .forecast-date {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .forecast-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .forecast-temp {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .last-updated {
            margin-top: 25px;
            font-size: 12px;
            color: #95a5a6;
            padding-top: 20px;
            border-top: 1px solid rgba(149, 165, 166, 0.2);
        }
        
        .cache-info {
            margin-top: 10px;
            font-size: 11px;
            color: #bdc3c7;
            font-style: italic;
        }
        
        /* Responsive design */
        @media (max-width: 480px) {
            .weather-container {
                padding: 20px;
                margin: 10px;
            }
            
            .current-weather {
                flex-direction: column;
                gap: 10px;
            }
            
            .weather-icon {
                font-size: 50px;
            }
            
            .temperature {
                font-size: 36px;
            }
            
            .details {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .forecast-days {
                gap: 5px;
            }
            
            .forecast-day {
                min-width: 70px;
                padding: 12px 8px;
            }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            }
            
            .weather-container {
                background: rgba(44, 62, 80, 0.95);
                color: #ecf0f1;
            }
            
            .location, .temperature, .detail-value, .forecast-temp {
                color: #ecf0f1;
            }
            
            .description, .detail-label {
                color: #bdc3c7;
            }
            
            .detail-item {
                background: rgba(52, 73, 94, 0.3);
            }
            
            .detail-item:hover {
                background: rgba(52, 73, 94, 0.5);
            }
            
            .forecast-day {
                background: rgba(52, 73, 94, 0.2);
            }
            
            .forecast-day:hover {
                background: rgba(52, 73, 94, 0.4);
            }
        }
    </style>
</head>
<body>
    <div class="weather-container" id="weatherContainer">
        <div class="loading">≈Åadowanie prognozy pogody...</div>
    </div>

    <script>
        // Konfiguracja
        const CONFIG = {
            dataUrl: './data/weather.json',
            fallbackCity: 'Warsaw',
            retryAttempts: 3,
            retryDelay: 1000
        };
        
        // Pobierz parametry z URL
        const urlParams = new URLSearchParams(window.location.search);
        const requestedCity = urlParams.get('city') || urlParams.get('location') || CONFIG.fallbackCity;
        
        // Mapowanie ikon pogody
        const weatherIcons = {
            '01d': '‚òÄÔ∏è', '01n': 'üåô',
            '02d': '‚õÖ', '02n': '‚òÅÔ∏è',
            '03d': '‚òÅÔ∏è', '03n': '‚òÅÔ∏è',
            '04d': '‚òÅÔ∏è', '04n': '‚òÅÔ∏è',
            '09d': 'üåßÔ∏è', '09n': 'üåßÔ∏è',
            '10d': 'üå¶Ô∏è', '10n': 'üåßÔ∏è',
            '11d': '‚õàÔ∏è', '11n': '‚õàÔ∏è',
            '13d': '‚ùÑÔ∏è', '13n': '‚ùÑÔ∏è',
            '50d': 'üå´Ô∏è', '50n': 'üå´Ô∏è'
        };
        
        /**
         * ≈Åaduje dane pogodowe z cache
         * @param {number} attempt - numer pr√≥by
         * @returns {Promise<Object>} - dane pogodowe
         */
        async function loadWeatherData(attempt = 1) {
            try {
                console.log(`Loading weather data (attempt ${attempt})...`);
                
                const response = await fetch(CONFIG.dataUrl + '?t=' + Date.now());
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data || typeof data !== 'object') {
                    throw new Error('Invalid data format');
                }
                
                return data;
            } catch (error) {
                console.error(`Attempt ${attempt} failed:`, error.message);
                
                if (attempt < CONFIG.retryAttempts) {
                    console.log(`Retrying in ${CONFIG.retryDelay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, CONFIG.retryDelay));
                    return loadWeatherData(attempt + 1);
                }
                
                throw error;
            }
        }
        
        /**
         * Znajduje dane dla miasta w cache
         * @param {Object} weatherData - dane pogodowe
         * @param {string} cityName - nazwa miasta
         * @returns {Object|null} - dane dla miasta lub null
         */
        function findCityData(weatherData, cityName) {
            const normalizedCity = cityName.toLowerCase().trim();
            
            // Dok≈Çadne dopasowanie
            if (weatherData[normalizedCity]) {
                return weatherData[normalizedCity];
            }
            
            // Wyszukiwanie czƒô≈õciowe
            const partialMatch = Object.keys(weatherData).find(key => {
                if (key.startsWith('_')) return false; // Pomi≈Ñ metadane
                return key.includes(normalizedCity) || normalizedCity.includes(key);
            });
            
            if (partialMatch) {
                return weatherData[partialMatch];
            }
            
            // Wyszukiwanie podobnych nazw (bez polskich znak√≥w)
            const normalizedSearch = normalizedCity
                .replace(/ƒÖ/g, 'a').replace(/ƒá/g, 'c').replace(/ƒô/g, 'e')
                .replace(/≈Ç/g, 'l').replace(/≈Ñ/g, 'n').replace(/√≥/g, 'o')
                .replace(/≈õ/g, 's').replace(/≈∫/g, 'z').replace(/≈º/g, 'z');
            
            const similarMatch = Object.keys(weatherData).find(key => {
                if (key.startsWith('_')) return false;
                const normalizedKey = key
                    .replace(/ƒÖ/g, 'a').replace(/ƒá/g, 'c').replace(/ƒô/g, 'e')
                    .replace(/≈Ç/g, 'l').replace(/≈Ñ/g, 'n').replace(/√≥/g, 'o')
                    .replace(/≈õ/g, 's').replace(/≈∫/g, 'z').replace(/≈º/g, 'z');
                return normalizedKey.includes(normalizedSearch) || normalizedSearch.includes(normalizedKey);
            });
            
            return similarMatch ? weatherData[similarMatch] : null;
        }
        
        /**
         * Formatuje datƒô
         * @param {number} timestamp - timestamp Unix
         * @returns {string} - sformatowana data
         */
        function formatDate(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleDateString('pl-PL', { 
                weekday: 'short',
                day: 'numeric',
                month: 'short'
            });
        }
        
        /**
         * Wy≈õwietla dane pogodowe
         * @param {Object} cityData - dane pogodowe dla miasta
         * @param {Object} metadata - metadane cache
         */
        function displayWeather(cityData, metadata) {
            const { current, forecast } = cityData;
            const container = document.getElementById('weatherContainer');
            
            // Przygotuj prognozƒô dziennƒÖ (max 5 dni)
            const dailyForecast = [];
            const processedDates = new Set();
            
            forecast.list.forEach(item => {
                const date = new Date(item.dt * 1000).toDateString();
                if (!processedDates.has(date) && dailyForecast.length < 5) {
                    dailyForecast.push(item);
                    processedDates.add(date);
                }
            });
            
            container.innerHTML = `
                <div class="location">${current.name}, ${current.country}</div>
                
                <div class="current-weather">
                    <div class="weather-icon">${weatherIcons[current.icon] || 'üå§Ô∏è'}</div>
                    <div class="temperature">${Math.round(current.temp)}¬∞C</div>
                </div>
                
                <div class="description">${current.description}</div>
                
                <div class="details">
                    <div class="detail-item">
                        <div class="detail-label">Odczuwalna</div>
                        <div class="detail-value">${Math.round(current.feels_like)}¬∞C</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Wilgotno≈õƒá</div>
                        <div class="detail-value">${current.humidity}%</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Wiatr</div>
                        <div class="detail-value">${Math.round(current.wind.speed * 3.6)} km/h</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Ci≈õnienie</div>
                        <div class="detail-value">${current.pressure} hPa</div>
                    </div>
                </div>
                
                <div class="forecast">
                    <div class="forecast-title">Prognoza 5-dniowa</div>
                    <div class="forecast-days">
                        ${dailyForecast.map(day => `
                            <div class="forecast-day">
                                <div class="forecast-date">${formatDate(day.dt)}</div>
                                <div class="forecast-icon">${weatherIcons[day.weather[0].icon] || 'üå§Ô∏è'}</div>
                                <div class="forecast-temp">
                                    ${Math.round(day.main.temp_max)}¬∞/${Math.round(day.main.temp_min)}¬∞
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="last-updated">
                    Aktualizacja: ${new Date(cityData.lastUpdated).toLocaleString('pl-PL')}
                </div>
                
                ${metadata ? `
                    <div class="cache-info">
                        Cache: ${metadata.totalCities} miast, ostatnia aktualizacja ${new Date(metadata.lastUpdate).toLocaleString('pl-PL')}
                    </div>
                ` : ''}
            `;
        }
        
        /**
         * Wy≈õwietla b≈ÇƒÖd
         * @param {string} message - wiadomo≈õƒá b≈Çƒôdu
         * @param {Object} metadata - metadane cache (opcjonalne)
         */
        function displayError(message, metadata = null) {
            const container = document.getElementById('weatherContainer');
            
            const availableCities = metadata && metadata.availableCities 
                ? metadata.availableCities.slice(0, 10).join(', ') + (metadata.availableCities.length > 10 ? '...' : '')
                : 'Warsaw, Paris, London, New York, Tokyo';
            
            container.innerHTML = `
                <div class="error">
                    ‚ùå ${message}<br>
                    <small>
                        <strong>Dostƒôpne miasta:</strong><br>
                        ${availableCities}
                        ${metadata ? `<br><br><strong>≈ÅƒÖcznie miast w cache:</strong> ${metadata.totalCities}` : ''}
                    </small>
                </div>
            `;
        }
        
        /**
         * G≈Ç√≥wna funkcja ≈ÇadujƒÖca pogodƒô
         */
        async function loadWeather() {
            try {
                console.log(`üå§Ô∏è Loading weather for: ${requestedCity}`);
                
                // Za≈Çaduj dane z cache
                const weatherData = await loadWeatherData();
                const metadata = weatherData._metadata;
                
                console.log(`üìä Cache contains ${metadata?.totalCities || 0} cities`);
                console.log(`üïê Last cache update: ${metadata?.lastUpdate || 'unknown'}`);
                
                // Znajd≈∫ dane dla ≈ºƒÖdanego miasta
                const cityData = findCityData(weatherData, requestedCity);
                
                if (cityData) {
                    console.log(`‚úÖ Found data for: ${cityData.current.name}`);
                    displayWeather(cityData, metadata);
                } else {
                    console.log(`‚ùå No data found for: ${requestedCity}`);
                    displayError(`Brak danych dla miasta: ${requestedCity}`, metadata);
                }
                
            } catch (error) {
                console.error('üí• Error loading weather:', error);
                displayError(`B≈ÇƒÖd ≈Çadowania danych: ${error.message}`);
            }
        }
        
        // Za≈Çaduj pogodƒô po za≈Çadowaniu strony
        document.addEventListener('DOMContentLoaded', loadWeather);
        
        // Automatyczne od≈õwie≈ºanie co 10 minut
        setInterval(() => {
            console.log('üîÑ Auto-refreshing weather data...');
            loadWeather();
        }, 10 * 60 * 1000);
        
        // Debug info
        console.log('üå§Ô∏è Weather Widget for Notion - GitHub Pages Edition');
        console.log(`üìç Requested city: ${requestedCity}`);
        console.log(`üîó Data URL: ${CONFIG.dataUrl}`);
    </script>
</body>
</html>
name: ðŸŒ¤ï¸ Update Weather Data

on:
  schedule:
    # Aktualizuj co godzinÄ™ (0 minut kaÅ¼dej godziny)
    - cron: '0 * * * *'
  workflow_dispatch: # Pozwala na rÄ™czne uruchomienie
    inputs:
      test_city:
        description: 'Test specific city (optional)'
        required: false
        default: 'Gdansk'
  push:
    branches: [ main, master ]
    paths:
      - 'update-weather.js'
      - '.github/workflows/update-weather.yml'

jobs:
  update-weather:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ”„ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm install
        
    - name: ðŸ§ª Test API connection (if test city provided)
      if: github.event.inputs.test_city != ''
      env:
        OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
      run: |
        echo "Testing weather API with city: ${{ github.event.inputs.test_city }}"
        node update-weather.js test "${{ github.event.inputs.test_city }}"
        
    - name: ðŸŒ¤ï¸ Update weather data
      if: github.event.inputs.test_city == ''
      env:
        OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
      run: |
        echo "Starting weather data update..."
        node update-weather.js
        
    - name: ðŸ“Š Check data file
      run: |
        if [ -f "data/weather.json" ]; then
          echo "âœ… Weather data file created successfully"
          echo "ðŸ“ File size: $(du -h data/weather.json | cut -f1)"
          echo "ðŸ“ˆ Number of cities: $(jq '._metadata.totalCities // 0' data/weather.json)"
          echo "ðŸ• Last update: $(jq -r '._metadata.lastUpdate // "unknown"' data/weather.json)"
        else
          echo "âŒ Weather data file not found!"
          exit 1
        fi
        
    - name: ðŸ” Validate JSON structure
      run: |
        echo "Validating JSON structure..."
        if jq empty data/weather.json; then
          echo "âœ… JSON is valid"
        else
          echo "âŒ Invalid JSON structure"
          exit 1
        fi
        
        # Check if we have at least some cities
        CITY_COUNT=$(jq '._metadata.totalCities // 0' data/weather.json)
        if [ "$CITY_COUNT" -gt 0 ]; then
          echo "âœ… Found $CITY_COUNT cities in cache"
        else
          echo "âš ï¸ Warning: No cities found in cache"
        fi
        
    - name: ðŸ“ Generate summary
      run: |
        echo "## ðŸŒ¤ï¸ Weather Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Update Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Total Cities:** $(jq '._metadata.totalCities // 0' data/weather.json)" >> $GITHUB_STEP_SUMMARY
        echo "**Successful Updates:** $(jq '._metadata.successfulUpdates // 0' data/weather.json)" >> $GITHUB_STEP_SUMMARY
        echo "**Failed Updates:** $(jq '._metadata.failedUpdates // 0' data/weather.json)" >> $GITHUB_STEP_SUMMARY
        echo "**File Size:** $(du -h data/weather.json | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Available Cities:" >> $GITHUB_STEP_SUMMARY
        jq -r '._metadata.availableCities[]?' data/weather.json | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸš€ Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action ðŸ¤–"
        
        # SprawdÅº czy sÄ… zmiany
        if git diff --quiet data/weather.json; then
          echo "ðŸ“ No changes in weather data"
        else
          echo "ðŸ“ Weather data updated, committing changes..."
          git add data/weather.json
          
          # UtwÃ³rz commit message z informacjami o aktualizacji
          SUCCESSFUL=$(jq '._metadata.successfulUpdates // 0' data/weather.json)
          FAILED=$(jq '._metadata.failedUpdates // 0' data/weather.json)
          TOTAL=$(jq '._metadata.totalCities // 0' data/weather.json)
          
          git commit -m "ðŸŒ¤ï¸ Update weather data ($(date '+%Y-%m-%d %H:%M'))" \
                     -m "" \
                     -m "ðŸ“Š Cities updated: $SUCCESSFUL" \
                     -m "âŒ Failed updates: $FAILED" \
                     -m "ðŸ“ˆ Total cities: $TOTAL" \
                     -m "" \
                     -m "ðŸ¤– Automated update by GitHub Actions"
          
          git push
          echo "âœ… Changes pushed successfully"
        fi
        
  # Job do sprawdzania statusu GitHub Pages
  check-pages:
    needs: update-weather
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ðŸŒ Check GitHub Pages status
      run: |
        echo "ðŸ” Checking GitHub Pages deployment..."
        
        # Pobierz informacje o repozytorium
        REPO_OWNER="${{ github.repository_owner }}"
        REPO_NAME="${{ github.event.repository.name }}"
        
        echo "ðŸ“ Repository: $REPO_OWNER/$REPO_NAME"
        echo "ðŸŒ Expected Pages URL: https://$REPO_OWNER.github.io/$REPO_NAME/"
        echo "ðŸŒ¤ï¸ Weather Widget URL: https://$REPO_OWNER.github.io/$REPO_NAME/weather-widget.html?city=Warsaw"
        
        # Dodaj do summary
        echo "## ðŸŒ GitHub Pages Info" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Pages URL:** https://$REPO_OWNER.github.io/$REPO_NAME/" >> $GITHUB_STEP_SUMMARY
        echo "**Weather Widget:** https://$REPO_OWNER.github.io/$REPO_NAME/weather-widget.html?city=Warsaw" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test URLs:" >> $GITHUB_STEP_SUMMARY
        echo "- [Warsaw](https://$REPO_OWNER.github.io/$REPO_NAME/weather-widget.html?city=Warsaw)" >> $GITHUB_STEP_SUMMARY
        echo "- [Paris](https://$REPO_OWNER.github.io/$REPO_NAME/weather-widget.html?city=Paris)" >> $GITHUB_STEP_SUMMARY
        echo "- [London](https://$REPO_OWNER.github.io/$REPO_NAME/weather-widget.html?city=London)" >> $GITHUB_STEP_SUMMARY
        echo "- [New York](https://$REPO_OWNER.github.io/$REPO_NAME/weather-widget.html?city=New%20York)" >> $GITHUB_STEP_SUMMARY